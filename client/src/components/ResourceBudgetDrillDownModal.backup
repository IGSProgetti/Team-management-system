import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  X, ChevronDown, ChevronRight, Building2, FolderKanban, 
  ListTodo, CheckSquare, Clock, DollarSign, TrendingUp, 
  TrendingDown, AlertCircle, Layers, Gift, Minus
} from 'lucide-react';
import api from '../utils/api';

const ResourceBudgetDrillDownModal = ({ risorsa, onClose }) => {
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [gerarchia, setGerarchia] = useState([]);
  const [expandedClients, setExpandedClients] = useState({});
  const [expandedProjects, setExpandedProjects] = useState({});
  const [expandedAreas, setExpandedAreas] = useState({});
  const [expandedActivities, setExpandedActivities] = useState({});
  // State per modal creazione task
  const [showCreateTaskModal, setShowCreateTaskModal] = useState(false);
  const [taskDataForModal, setTaskDataForModal] = useState(null);

  useEffect(() => {
    fetchDrillDown();
  }, [risorsa.id]);

  const fetchDrillDown = async () => {
    try {
      setLoading(true);
      const response = await api.get(`/bonus/resource/${risorsa.id}`);
      setGerarchia(response.data.hierarchy);
      setError(null);
    } catch (err) {
      console.error('Errore caricamento drill-down:', err);
      setError('Impossibile caricare i dettagli della risorsa');
    } finally {
      setLoading(false);
    }
  };

  // Toggle expand
  const toggleClient = (clientId) => {
    setExpandedClients(prev => ({ ...prev, [clientId]: !prev[clientId] }));
  };

  const toggleProject = (projectId) => {
    setExpandedProjects(prev => ({ ...prev, [projectId]: !prev[projectId] }));
  };

  const toggleArea = (areaId) => {
    setExpandedAreas(prev => ({ ...prev, [areaId]: !prev[areaId] }));
  };

  const toggleActivity = (activityId) => {
    setExpandedActivities(prev => ({ ...prev, [activityId]: !prev[activityId] }));
  };

  // Formattatori
  const formatCurrency = (value) => {
    return new Intl.NumberFormat('it-IT', {
      style: 'currency',
      currency: 'EUR'
    }).format(value);
  };

  const formatHours = (minutes) => {
    return `${(minutes / 60).toFixed(2)}h`;
  };

  const getStatusColor = (status) => {
    switch (status) {
      case 'completata': return 'bg-green-100 text-green-800';
      case 'in_esecuzione': return 'bg-blue-100 text-blue-800';
      case 'programmata': 
      case 'pianificata': return 'bg-gray-100 text-gray-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getDiffColor = (diff) => {
    if (diff > 0) return 'text-green-600';
    if (diff < 0) return 'text-red-600';
    return 'text-gray-600';
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <motion.div
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ opacity: 1, scale: 1 }}
        exit={{ opacity: 0, scale: 0.95 }}
        className="bg-white rounded-lg shadow-xl w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col"
      >
        {/* Header */}
        <div className="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 flex items-center justify-between">
          <div>
            <h2 className="text-2xl font-bold">Dettaglio Budget: {risorsa.nome}</h2>
            <p className="text-blue-100 text-sm mt-1">
              Navigazione completa Cliente â†’ Progetto â†’ Area â†’ AttivitÃ  â†’ Task
            </p>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-blue-700 rounded-lg transition-colors"
          >
            <X className="w-6 h-6" />
          </button>
        </div>

        {/* Info Risorsa */}
        <div className="bg-blue-50 border-b border-blue-200 px-6 py-4">
          <div className="grid grid-cols-4 gap-4">
            <InfoCard
              label="Monte Ore Totali"
              value={formatHours(risorsa.ore_annue_totali * 60)}
              icon={<Clock className="w-5 h-5" />}
            />
            <InfoCard
              label="Ore Progetti"
              value={`${formatHours(risorsa.ore_assegnate_progetti * 60)} / ${formatHours(risorsa.ore_annue_normali * 60)}`}
              icon={<FolderKanban className="w-5 h-5" />}
              subtext={`${risorsa.ore_disponibili_progetti >= 0 ? '+' : ''}${formatHours(risorsa.ore_disponibili_progetti * 60)} disp.`}
              subtextColor={risorsa.ore_disponibili_progetti >= 0 ? 'text-green-600' : 'text-red-600'}
            />
            <InfoCard
              label="Tesoretto"
              value={formatHours(risorsa.ore_disponibili_tesoretto * 60)}
              icon={<DollarSign className="w-5 h-5" />}
            />
            <InfoCard
              label="Budget Assegnato"
              value={formatCurrency(risorsa.budget_assegnato)}
              icon={<DollarSign className="w-5 h-5" />}
            />
          </div>
        </div>

        {/* Content */}
        <div className="flex-1 overflow-y-auto px-6 py-4">
          {loading ? (
            <div className="flex items-center justify-center h-64">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
          ) : error ? (
            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
              <div className="flex items-center gap-2 text-red-800">
                <AlertCircle className="w-5 h-5" />
                <span>{error}</span>
              </div>
            </div>
          ) : gerarchia.length === 0 ? (
            <div className="text-center py-12 text-gray-500">
              <FolderKanban className="w-16 h-16 mx-auto mb-4 text-gray-300" />
              <p>Nessun progetto assegnato a questa risorsa</p>
            </div>
          ) : (
            <div className="space-y-4">
              {gerarchia.map(cliente => (
                <ClienteSection
                  key={cliente.id}
                  cliente={cliente}
                  expanded={expandedClients[cliente.id]}
                  onToggle={() => toggleClient(cliente.id)}
                  expandedProjects={expandedProjects}
                  toggleProject={toggleProject}
                  expandedAreas={expandedAreas}
                  toggleArea={toggleArea}
                  expandedActivities={expandedActivities}
                  toggleActivity={toggleActivity}
                  formatCurrency={formatCurrency}
                  formatHours={formatHours}
                  getStatusColor={getStatusColor}
                  getDiffColor={getDiffColor}
                  fetchDrillDown={fetchDrillDown}
                  setTaskDataForModal={setTaskDataForModal}
                  setShowCreateTaskModal={setShowCreateTaskModal}
                />
              ))}
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="bg-gray-50 border-t border-gray-200 px-6 py-4 flex justify-end">
          <button
            onClick={onClose}
            className="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors"
          >
            Chiudi
          </button>
        </div>
      </motion.div>

      {/* Modal Creazione Task Recupero */}
      {showCreateTaskModal && (
        <CreateTaskRecuperoModal
          isOpen={showCreateTaskModal}
          onClose={() => {
            setShowCreateTaskModal(false);
            setTaskDataForModal(null);
          }}
          taskData={taskDataForModal}
          onSuccess={() => {
            fetchDrillDown();
          }}
        />
      )}
    </div>
  );
};

// Info Card Component
const InfoCard = ({ label, value, icon, subtext, subtextColor = 'text-gray-500' }) => (
  <div className="bg-white rounded-lg p-3 border border-blue-200">
    <div className="flex items-center gap-2 text-blue-600 mb-1">
      {icon}
      <span className="text-xs font-medium text-gray-600">{label}</span>
    </div>
    <p className="text-lg font-bold text-gray-900">{value}</p>
    {subtext && <p className={`text-xs font-medium mt-1 ${subtextColor}`}>{subtext}</p>}
  </div>
);

// Cliente Section
const ClienteSection = ({
  cliente,
  expanded,
  onToggle,
  expandedProjects,
  toggleProject,
  expandedAreas,
  toggleArea,
  expandedActivities,
  toggleActivity,
  formatCurrency,
  formatHours,
  getStatusColor,
  getDiffColor,
  fetchDrillDown,
  setTaskDataForModal,
  setShowCreateTaskModal
}) => {
  
  // Calcola totali ore preventivate e effettive
  const totalOrePreventivate = cliente.progetti.reduce((sum, prog) => 
    sum + prog.aree.reduce((aSum, area) => 
      aSum + area.attivita.reduce((attSum, att) => 
        attSum + att.tasks.reduce((tSum, task) => tSum + (task.ore_stimate || 0), 0)
      , 0)
    , 0)
  , 0);
  
  const totalOreEffettive = cliente.progetti.reduce((sum, prog) => 
    sum + prog.aree.reduce((aSum, area) => 
      aSum + area.attivita.reduce((attSum, att) => 
        attSum + att.tasks.reduce((tSum, task) => tSum + (task.ore_effettive || 0), 0)
      , 0)
    , 0)
  , 0);
  
  const bonusTotale = cliente.bonus_totale || 0;
  
  return (
    <div className="border border-gray-200 rounded-lg overflow-hidden">
      <button
        onClick={onToggle}
        className="w-full bg-gray-50 hover:bg-gray-100 transition-colors px-4 py-3"
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-blue-100 rounded-lg">
              <Building2 className="w-5 h-5 text-blue-600" />
            </div>
            <div className="text-left">
              <h3 className="font-semibold text-gray-900">{cliente.nome}</h3>
              <div className="flex gap-4 text-xs text-gray-600 mt-1">
                <span>Budget: {formatCurrency(cliente.budget)}</span>
                <span>Ore Prev: {formatHours(totalOrePreventivate)}</span>
                <span>Ore Eff: {formatHours(totalOreEffettive)}</span>
                <span className={`font-bold ${bonusTotale >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  Bonus: {formatCurrency(bonusTotale)}
                </span>
              </div>
            </div>
          </div>
          {expanded ? <ChevronDown className="w-5 h-5" /> : <ChevronRight className="w-5 h-5" />}
        </div>
      </button>

      <AnimatePresence>
        {expanded && (
          <motion.div
            initial={{ height: 0 }}
            animate={{ height: 'auto' }}
            exit={{ height: 0 }}
            className="overflow-hidden"
          >
            <div className="p-4 space-y-3">
              {cliente.progetti.map(progetto => (
                <ProgettoSection
                  key={progetto.id}
                  progetto={progetto}
                  expanded={expandedProjects[progetto.id]}
                  onToggle={() => toggleProject(progetto.id)}
                  expandedAreas={expandedAreas}
                  toggleArea={toggleArea}
                  expandedActivities={expandedActivities}
                  toggleActivity={toggleActivity}
                  formatCurrency={formatCurrency}
                  formatHours={formatHours}
                  getStatusColor={getStatusColor}
                  getDiffColor={getDiffColor}
                  fetchDrillDown={fetchDrillDown}
                  setTaskDataForModal={setTaskDataForModal}
                  setShowCreateTaskModal={setShowCreateTaskModal}
                />
              ))}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

// Progetto Section
const ProgettoSection = ({
  progetto,
  expanded,
  onToggle,
  expandedAreas,
  toggleArea,
  expandedActivities,
  toggleActivity,
  formatCurrency,
  formatHours,
  getStatusColor,
  getDiffColor,
  fetchDrillDown,
  setTaskDataForModal,
  setShowCreateTaskModal
}) => {
  
  // Calcola totali
  const totalOrePreventivate = progetto.aree.reduce((sum, area) => 
    sum + area.attivita.reduce((attSum, att) => 
      attSum + att.tasks.reduce((tSum, task) => tSum + (task.ore_stimate || 0), 0)
    , 0)
  , 0);
  
  const totalOreEffettive = progetto.aree.reduce((sum, area) => 
    sum + area.attivita.reduce((attSum, att) => 
      attSum + att.tasks.reduce((tSum, task) => tSum + (task.ore_effettive || 0), 0)
    , 0)
  , 0);
  
  const bonusTotale = progetto.bonus_totale || 0;
  
  return (
    <div className="border border-gray-200 rounded-lg overflow-hidden ml-8">
      <button
        onClick={onToggle}
        className="w-full bg-white hover:bg-gray-50 transition-colors px-4 py-3"
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-purple-100 rounded-lg">
              <FolderKanban className="w-4 h-4 text-purple-600" />
            </div>
            <div className="text-left">
              <h4 className="font-semibold text-gray-900 text-sm">{progetto.nome}</h4>
              <div className="flex gap-4 text-xs text-gray-600 mt-1">
                <span>Ore Ass: {formatHours(progetto.ore_assegnate * 60)}</span>
                <span>Ore Prev: {formatHours(totalOrePreventivate)}</span>
                <span>Ore Eff: {formatHours(totalOreEffettive)}</span>
                <span className={`font-bold ${bonusTotale >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  Bonus: {formatCurrency(bonusTotale)}
                </span>
              </div>
            </div>
          </div>
          {expanded ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
        </div>
      </button>

      <AnimatePresence>
        {expanded && (
          <motion.div
            initial={{ height: 0 }}
            animate={{ height: 'auto' }}
            exit={{ height: 0 }}
            className="overflow-hidden bg-gray-50"
          >
            <div className="p-3 space-y-2">
              {progetto.aree.length === 0 ? (
                <p className="text-sm text-gray-500 italic ml-4">Nessuna area in questo progetto</p>
              ) : (
                progetto.aree.map(area => (
                  <AreaSection
                    key={area.id || 'senza_area'}
                    area={area}
                    expanded={expandedAreas[area.id || 'senza_area']}
                    onToggle={() => toggleArea(area.id || 'senza_area')}
                    expandedActivities={expandedActivities}
                    toggleActivity={toggleActivity}
                    formatCurrency={formatCurrency}
                    formatHours={formatHours}
                    getStatusColor={getStatusColor}
                    getDiffColor={getDiffColor}
                    fetchDrillDown={fetchDrillDown}
                    setTaskDataForModal={setTaskDataForModal}
                    setShowCreateTaskModal={setShowCreateTaskModal}
                  />
                ))
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

// Area Section
const AreaSection = ({
  area,
  expanded,
  onToggle,
  expandedActivities,
  toggleActivity,
  formatCurrency,
  formatHours,
  getStatusColor,
  getDiffColor,
  fetchDrillDown,
  setTaskDataForModal,
  setShowCreateTaskModal
}) => {
  
  // Calcola totali
  const totalOrePreventivate = area.attivita.reduce((sum, att) => 
    sum + att.tasks.reduce((tSum, task) => tSum + (task.ore_stimate || 0), 0)
  , 0);
  
  const totalOreEffettive = area.attivita.reduce((sum, att) => 
    sum + att.tasks.reduce((tSum, task) => tSum + (task.ore_effettive || 0), 0)
  , 0);
  
  const bonusTotale = area.bonus_totale || 0;
  
  return (
    <div className="border border-gray-200 rounded-lg overflow-hidden ml-8 bg-white">
      <button
        onClick={onToggle}
        className="w-full hover:bg-gray-50 transition-colors px-3 py-2"
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="p-1.5 bg-green-100 rounded">
              <Layers className="w-3.5 h-3.5 text-green-600" />
            </div>
            <div className="text-left">
              <h5 className="font-medium text-gray-900 text-xs">{area.nome}</h5>
              <div className="flex gap-3 text-xs text-gray-600 mt-0.5">
                <span>Ore Prev: {formatHours(totalOrePreventivate)}</span>
                <span>Ore Eff: {formatHours(totalOreEffettive)}</span>
                <span className={`font-bold ${bonusTotale >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  Bonus: {formatCurrency(bonusTotale)}
                </span>
              </div>
            </div>
          </div>
          {expanded ? <ChevronDown className="w-3.5 h-3.5" /> : <ChevronRight className="w-3.5 h-3.5" />}
        </div>
      </button>

      <AnimatePresence>
        {expanded && (
          <motion.div
            initial={{ height: 0 }}
            animate={{ height: 'auto' }}
            exit={{ height: 0 }}
            className="overflow-hidden bg-gray-50"
          >
            <div className="p-2 space-y-2">
              {area.attivita.length === 0 ? (
                <p className="text-xs text-gray-500 italic ml-3">Nessuna attivitÃ  in quest'area</p>
              ) : (
                area.attivita.map(attivita => (
                  <AttivitaSection
                    key={attivita.id}
                    attivita={attivita}
                    expanded={expandedActivities[attivita.id]}
                    onToggle={() => toggleActivity(attivita.id)}
                    formatHours={formatHours}
                    getStatusColor={getStatusColor}
                    getDiffColor={getDiffColor}
                    formatCurrency={formatCurrency}
                    fetchDrillDown={fetchDrillDown}
                    setTaskDataForModal={setTaskDataForModal}
                    setShowCreateTaskModal={setShowCreateTaskModal}
                  />
                ))
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

// AttivitÃ  Section
const AttivitaSection = ({
  attivita,
  expanded,
  onToggle,
  formatHours,
  getStatusColor,
  getDiffColor,
  formatCurrency,
  fetchDrillDown,
  setTaskDataForModal,
  setShowCreateTaskModal
}) => {
  
  // Calcola totali dalle task
  const totalOrePreventivate = attivita.tasks.reduce((sum, task) => sum + (task.ore_stimate || 0), 0);
  const totalOreEffettive = attivita.tasks.reduce((sum, task) => sum + (task.ore_effettive || 0), 0);
  const bonusTotale = attivita.bonus_totale || 0;
  
  // Calcola budget (usa il costo orario dalla prima task con bonus)
  const costoOrario = attivita.tasks.find(t => t.bonus)?.bonus?.costo_orario_finale || 0;
  const budgetPreventivo = (totalOrePreventivate / 60) * costoOrario;
  const budgetEffettivo = (totalOreEffettive / 60) * costoOrario;
  
  return (
    <div className="border border-gray-200 rounded-lg overflow-hidden ml-6 bg-white">
      <button
        onClick={onToggle}
        className="w-full hover:bg-gray-50 transition-colors px-3 py-2"
      >
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-2">
            <div className="p-1 bg-orange-100 rounded">
              <ListTodo className="w-3 h-3 text-orange-600" />
            </div>
            <div className="text-left">
              <h6 className="font-medium text-gray-900 text-xs">{attivita.nome}</h6>
              <div className="flex gap-3 text-xs text-gray-600 mt-0.5">
                <span>Prev: {formatHours(totalOrePreventivate)}</span>
                <span>Eff: {formatHours(totalOreEffettive)}</span>
                <span>Budget Prev: {formatCurrency(budgetPreventivo)}</span>
                <span>Budget Eff: {formatCurrency(budgetEffettivo)}</span>
                <span className={`font-bold ${bonusTotale >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                  Bonus: {formatCurrency(bonusTotale)}
                </span>
              </div>
            </div>
          </div>
          {expanded ? <ChevronDown className="w-3 h-3" /> : <ChevronRight className="w-3 h-3" />}
        </div>
      </button>

      <AnimatePresence>
        {expanded && (
          <motion.div
            initial={{ height: 0 }}
            animate={{ height: 'auto' }}
            exit={{ height: 0 }}
            className="overflow-hidden bg-gray-50"
          >
            <div className="p-3">
              {attivita.tasks.length === 0 ? (
                <p className="text-xs text-gray-500 italic ml-2">Nessuna task in questa attivitÃ </p>
              ) : (
                <TaskTableView
  tasks={attivita.tasks}
  attivitaId={attivita.id}
  formatHours={formatHours}
  formatCurrency={formatCurrency}
  getStatusColor={getStatusColor}
  fetchDrillDown={fetchDrillDown}
  setTaskDataForModal={setTaskDataForModal}
  setShowCreateTaskModal={setShowCreateTaskModal}
/>
              )}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
};

// Tabella Dettagliata Tasks con Bonus (Stile Excel)
const TaskTableView = ({ 
  tasks,
  attivitaId,
  formatHours, 
  formatCurrency, 
  getStatusColor, 
  fetchDrillDown, 
  setTaskDataForModal, 
  setShowCreateTaskModal 
}) => {
  // Calcola totali
  const totaleBonus = tasks.reduce((sum, task) => {
    if (task.bonus && task.bonus.stato === 'pending') {
      return sum + parseFloat(task.bonus.importo_bonus || 0);
    }
    return sum;
  }, 0);

  const totaleBonusApprovato = tasks.reduce((sum, task) => {
    if (task.bonus && task.bonus.stato === 'approvato') {
      return sum + parseFloat(task.bonus.importo_bonus || 0);
    }
    return sum;
  }, 0);

  return (
    <div className="overflow-x-auto">
      <table className="min-w-full bg-white border border-gray-300 text-xs">
        <thead className="bg-gray-100">
          <tr>
            <th className="px-2 py-2 border-b text-left font-semibold">Nome Task</th>
            <th className="px-2 py-2 border-b text-center font-semibold">Stato</th>
            <th className="px-2 py-2 border-b text-right font-semibold">Ore Prev.</th>
            <th className="px-2 py-2 border-b text-right font-semibold">Ore Eff.</th>
            <th className="px-2 py-2 border-b text-right font-semibold">Costo Orario</th>
            <th className="px-2 py-2 border-b text-right font-semibold">Totale Prev.</th>
            <th className="px-2 py-2 border-b text-right font-semibold">Totale Eff.</th>
            <th className="px-2 py-2 border-b text-right font-semibold">Diff.</th>
            <th className="px-2 py-2 border-b text-right font-semibold">% Bonus</th>
            <th className="px-2 py-2 border-b text-right font-semibold">Bonus/PenalitÃ </th>
            <th className="px-2 py-2 border-b text-center font-semibold">Azioni</th>
          </tr>
        </thead>
        <tbody>
          {tasks.map((task) => {
            const orePreventivate = task.ore_stimate / 60;
            const oreEffettive = task.ore_effettive ? task.ore_effettive / 60 : 0;
            const costoOrario = task.bonus ? task.bonus.costo_orario_finale : 0;
            const totalePrev = orePreventivate * costoOrario;
            const totaleEff = oreEffettive * costoOrario;
            const diff = totalePrev - totaleEff;
            const percentualeBonus = task.bonus ? task.bonus.percentuale_bonus : 0;
            const importoBonus = task.bonus ? parseFloat(task.bonus.importo_bonus) : 0;

            return (
              <tr key={task.id} className="hover:bg-gray-50">
                <td className="px-2 py-2 border-b">{task.nome}</td>
                <td className="px-2 py-2 border-b text-center">
                  <span className={`px-2 py-1 rounded-full text-xs ${getStatusColor(task.stato)}`}>
                    {task.stato}
                  </span>
                </td>
                <td className="px-2 py-2 border-b text-right">{orePreventivate.toFixed(2)}h</td>
                <td className="px-2 py-2 border-b text-right">
                  {task.ore_effettive !== null ? `${oreEffettive.toFixed(2)}h` : '-'}
                </td>
                <td className="px-2 py-2 border-b text-right">{formatCurrency(costoOrario)}/h</td>
                <td className="px-2 py-2 border-b text-right">{formatCurrency(totalePrev)}</td>
                <td className="px-2 py-2 border-b text-right">
                  {task.ore_effettive !== null ? formatCurrency(totaleEff) : '-'}
                </td>
                <td className={`px-2 py-2 border-b text-right font-semibold ${
                  diff > 0 ? 'text-green-600' : diff < 0 ? 'text-red-600' : 'text-gray-600'
                }`}>
                  {task.ore_effettive !== null ? formatCurrency(diff) : '-'}
                </td>
                <td className="px-2 py-2 border-b text-right">
                  {percentualeBonus > 0 ? `${percentualeBonus}%` : '-'}
                </td>
                <td className={`px-2 py-2 border-b text-right font-bold ${
                  importoBonus > 0 ? 'text-green-600' : 
                  importoBonus < 0 ? 'text-red-600' : 'text-gray-600'
                }`}>
                  {task.bonus ? formatCurrency(importoBonus) : '-'}
                </td>
                
                {/* COLONNA AZIONI */}
                <td className="px-2 py-2 border-b text-center">
                  {/* Mostra pulsanti se bonus non Ã¨ stato ancora gestito */}
                  {task.bonus && (!task.bonus.stato_gestione || task.bonus.stato_gestione === 'non_gestito') && task.bonus.stato !== 'rifiutato' && (
                    <div className="flex flex-col gap-1">
                      {/* BONUS POSITIVO */}
                      {task.bonus.tipo === 'positivo' && (
                        <button
                          onClick={async () => {
                            if (!window.confirm('Confermi di voler pagare questo bonus? (VerrÃ  automaticamente approvato)')) return;
                            try {
                              await api.put(`/bonus/${task.bonus.id}/paga`, { note: 'Bonus pagato' });
                              alert('âœ… Bonus approvato e pagato!');
                              fetchDrillDown();
                            } catch (err) {
                              alert(err.response?.data?.error || 'Errore nel pagamento');
                            }
                          }}
                          className="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded text-xs font-medium transition"
                        >
                          ðŸ’° Paga Bonus
                        </button>
                      )}
                      
                      {/* PENALITÃ€ */}
                      {task.bonus.tipo === 'negativo' && (
                        <>
                          <button
                            onClick={async () => {
                              if (!window.confirm('Confermi di voler convertire questa penalitÃ  in ore disponibili? (VerrÃ  automaticamente approvata)')) return;
                              try {
                                const res = await api.put(`/bonus/${task.bonus.id}/converti-ore`, { note: 'Convertito in ore' });
                                alert(`âœ… PenalitÃ  approvata! Aggiunte ${res.data.ore_aggiunte.toFixed(2)}h al tesoretto!`);
                                fetchDrillDown();
                              } catch (err) {
                                alert(err.response?.data?.error || 'Errore nella conversione');
                              }
                            }}
                            className="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs font-medium transition"
                          >
                            ðŸ”„ Converti Ore
                          </button>
                          
                          <button
  onClick={() => {
    setTaskDataForModal({
      nome: `Recupero - ${task.nome}`,
      descrizione: `Task di recupero da penalitÃ  di ${Math.abs(task.bonus.differenza_ore / 60).toFixed(2)}h`,
      attivita_id: attivitaId,  // â† CORRETTO: usa l'ID dell'attivitÃ  dal componente padre
      utente_assegnato: task.bonus.risorsa_id,
      ore_stimate: Math.abs(task.bonus.differenza_ore),
      scadenza: new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0],
      bonus_id: task.bonus.id
    });
    setShowCreateTaskModal(true);
  }}
  className="px-3 py-1.5 bg-orange-600 hover:bg-orange-700 text-white rounded text-xs font-medium transition"
>
  âœ“ Crea Task
</button>
                        </>
                      )}
                    </div>
                  )}
                  
                  {/* GiÃ  gestito - Mostra badge di stato */}
                  {task.bonus && task.bonus.stato_gestione && task.bonus.stato_gestione !== 'non_gestito' && (
                    <>
                      {task.bonus.stato_gestione === 'pagato' && (
                        <span className="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                          ðŸ’° Pagato
                        </span>
                      )}
                      {task.bonus.stato_gestione === 'convertito_ore' && (
                        <span className="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs font-medium">
                          ðŸ”„ Convertito
                        </span>
                      )}
                      {task.bonus.stato_gestione === 'task_creata' && (
                        <span className="px-2 py-1 bg-indigo-100 text-indigo-800 rounded-full text-xs font-medium">
                          âœ“ Task Creata
                        </span>
                      )}
                    </>
                  )}
                  
                  {/* Bonus rifiutato */}
                  {task.bonus && task.bonus.stato === 'rifiutato' && (
                    <span className="px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs font-medium">
                      Rifiutato
                    </span>
                  )}
                  
                  {/* Nessun bonus */}
                  {!task.bonus && <span className="text-xs text-gray-400">-</span>}
                </td>
              </tr>
            );
          })}
        </tbody>
        <tfoot className="bg-gray-100 font-bold">
          <tr>
            <td colSpan="9" className="px-2 py-3 border-t text-right">
              Totale Bonus da Approvare:
            </td>
            <td className={`px-2 py-3 border-t text-right text-lg ${
              totaleBonus > 0 ? 'text-green-600' : 
              totaleBonus < 0 ? 'text-red-600' : 'text-gray-600'
            }`}>
              {formatCurrency(totaleBonus)}
            </td>
            <td className="px-2 py-3 border-t"></td>
          </tr>
          {totaleBonusApprovato !== 0 && (
            <tr>
              <td colSpan="9" className="px-2 py-2 border-t text-right text-sm">
                Totale Bonus Approvato:
              </td>
              <td className={`px-2 py-2 border-t text-right ${
                totaleBonusApprovato > 0 ? 'text-green-600' : 'text-red-600'
              }`}>
                {formatCurrency(totaleBonusApprovato)}
              </td>
              <td className="px-2 py-2 border-t"></td>
            </tr>
          )}
        </tfoot>
      </table>
    </div>
  );
};

// Modal Creazione Task Recupero
const CreateTaskRecuperoModal = ({ isOpen, onClose, taskData, onSuccess }) => {
  const [formData, setFormData] = useState({
    nome: taskData?.nome || '',
    descrizione: taskData?.descrizione || '',
    scadenza: taskData?.scadenza || ''
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    try {
      await api.post(`/bonus/${taskData.bonus_id}/crea-task-recupero`, {
        taskData: {
          nome: formData.nome,
          descrizione: formData.descrizione,
          attivita_id: taskData.attivita_id,
          scadenza: formData.scadenza
        }
      });
      
      alert('âœ… PenalitÃ  approvata e task di recupero creata!');
      onSuccess();
      onClose();
    } catch (err) {
      alert(err.response?.data?.error || 'Errore nella creazione');
    }
  };

  if (!isOpen || !taskData) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
        <div className="bg-orange-600 text-white p-4 rounded-t-lg flex items-center justify-between">
          <div>
            <h3 className="text-lg font-bold">Crea Task di Recupero</h3>
            <p className="text-sm text-orange-100 mt-1">
              PenalitÃ : {(Math.abs(taskData.ore_stimate) / 60).toFixed(2)}h
            </p>
          </div>
          <button onClick={onClose} className="text-white hover:bg-orange-700 rounded p-1">
            <X className="w-5 h-5" />
          </button>
        </div>

        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Nome Task *
            </label>
            <input
              type="text"
              value={formData.nome}
              onChange={(e) => setFormData({ ...formData, nome: e.target.value })}
              required
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="es: Recupero ore progetto X"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Descrizione
            </label>
            <textarea
              value={formData.descrizione}
              onChange={(e) => setFormData({ ...formData, descrizione: e.target.value })}
              rows={3}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Dettagli opzionali..."
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Scadenza *
            </label>
            <input
              type="date"
              value={formData.scadenza}
              onChange={(e) => setFormData({ ...formData, scadenza: e.target.value })}
              required
              min={new Date().toISOString().split('T')[0]}
              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
            />
          </div>

          <div className="bg-gray-50 rounded-lg p-3 space-y-1 text-sm">
            <p className="text-gray-600">
              <span className="font-medium">Ore stimate:</span> {(taskData.ore_stimate / 60).toFixed(2)}h (dalla penalitÃ )
            </p>
            <p className="text-gray-600">
              <span className="font-medium">Assegnata a:</span> Stessa risorsa (automatico)
            </p>
          </div>

          <div className="flex gap-3 pt-4">
            <button
              type="button"
              onClick={onClose}
              className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition"
            >
              Annulla
            </button>
            <button
              type="submit"
              className="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition flex items-center justify-center gap-2"
            >
              <CheckSquare className="w-4 h-4" />
              Crea Task
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

export default ResourceBudgetDrillDownModal;